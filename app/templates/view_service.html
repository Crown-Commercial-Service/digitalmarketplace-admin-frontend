{% import "toolkit/summary-table.html" as summary %}
{% import 'macros/answers.html' as answers %}

{% extends "_base_page.html" %}
{% block page_title %}
  {{ service_data['serviceName'] or service_data['frameworkName'] + ' - ' + service_data['lotName'] }} – Digital Marketplace admin
{% endblock %}

{% block breadcrumb %}
  {%
    with items = [
      {
        "link": url_for('.index'),
        "label": "Admin home"
      },
      {
        "link": url_for(".find_supplier_services", supplier_id=service_data['supplierId']),
        "label": service_data['supplierName']
      }
    ]
  %}
    {% include "toolkit/breadcrumb.html" %}
  {% endwith %}
{% endblock %}

{% block main_content %}

  {% block before_heading %}

    {# banners #}
    {% if publish and current_user.has_role('admin-ccs-category') and service_data['status'] != 'published' %}
        <form action="{{ url_for('.update_service_status', service_id=service_id ) }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="service_status" value="public" />
          {%
            with
            message = "Are you sure you want to publish ‘{}’?".format(
              service_data['serviceName'] or service_data['frameworkName'] + ' - ' + service_data['lotName']
            ),
            type = "destructive",
            action = '<button type="submit" class="button-destructive banner-action">Publish</button>'|safe
          %}
            {% include "toolkit/notification-banner.html" %}
          {% endwith %}
        </form>
    {% endif %}

    {% if remove and current_user.has_role('admin-ccs-category') and service_data['status'] == 'published' %}
      <form action="{{ url_for('.update_service_status', service_id=service_id ) }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="service_status" value="removed" />
        {%
          with
          message = "Are you sure you want to remove ‘{}’?".format(
            service_data['serviceName'] or service_data['frameworkName'] + ' - ' + service_data['lotName']
          ),
          type = "destructive",
          action = '<button type="submit" class="button-destructive banner-action">Remove</button>'|safe
        %}
          {% include "toolkit/notification-banner.html" %}
        {% endwith %}
      </form>
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for category, message in messages %}
        {% with message = message, type = "destructive" if category == 'error' else 'success' %}
          {% if message['status_updated'] %}
            {% if message['status_updated'] == 'public' %}
              {% set message = "You published ‘{}’.".format(service_data['serviceName'] or service_data['frameworkName'] + ' - ' + service_data['lotName']) %}
              {% include "toolkit/notification-banner.html" %}
            {% endif %}
          {% elif message['bad_status'] %}
            {% set message = "Not a valid status: {}".format(message['bad_status']) %}
            {% include "toolkit/notification-banner.html" %}
          {% elif message['status_error'] %}
            {% set message = "Error trying to update status of service: ".format(message['status_error']) %}
            {% include "toolkit/notification-banner.html" %}
          {% else %}
            {% include "toolkit/notification-banner.html" %}
          {% endif %}
        {% endwith %}
      {% endfor %}
    {% endwith %}

    {% if service_data['status'] != 'published' and removed_by %}
      {%
        with
        type = "temporary-message",
        heading = "Removed by {} on ".format(removed_by) + "{}.".format(removed_at|dateformat)|nbsp,
        message = (
          ("<a href='{}'>Publish service</a>"|safe).format(url_for('.view', service_id=service_id, publish=True))
          if current_user.has_role('admin-ccs-category') else ""
        )
      %}
        {% include "toolkit/notification-banner.html" %}
      {% endwith %}
    {% endif %}
    {# endbanners #}

  {% endblock %}


  {% if service_data %}
    {%
      with
      context = service_data['supplierName'],
      heading = service_data['serviceName'] or service_data['frameworkName'] + ' - ' + service_data['lotName'],
      smaller = True
    %}
      {% include "toolkit/page-heading.html" %}
    {% endwith %}

    {# links #}
    <ul class="list-no-bullet">
      {% if service_data['frameworkFramework'] == 'g-cloud' %}
        <li><a href="{{ "/{}/services/{}".format(service_data['frameworkFramework'], service_id) }}">View service</a></li>
      {% endif %}
      {% if current_user.has_role('admin-ccs-category') and service_data['status'] == 'published' %}
        <li><a href="{{ url_for('.view', service_id=service_id, remove=True) }}">Remove service</a></li>
      {% endif %}
    </ul>
    {# endlinks #}

    {% for section in sections %}
      {{ summary.heading(section.name) }}
      {% if section.editable and current_user.has_role('admin-ccs-category') %}
        {{ summary.top_link("Edit", url_for('.edit', service_id=service_id, section_id=section.id)) }}
      {% endif %}
      {% call(question) summary.list_table(
        section.questions,
        caption="Services",
        empty_message="This supplier has no services on the Digital Marketplace",
        field_headings=[
          'Service attribute name',
          'Service attribute'
        ],
        field_headings_visible=False
      ) %}
        {% call summary.row() %}
          {{ summary.field_name(question.label) }}
          {{ summary[question.type](question.value, question.assurance) }}
          {% if section.edit_questions and current_user.has_role('admin-ccs-category') %}
            {{ summary.edit_link('Add' if question.is_empty else 'Edit', url_for('.edit', service_id=service_id, section_id=section.id, question_slug=question.slug)) }}
          {% endif %}

        {% endcall %}
      {% endcall %}
    {% endfor %}
  {% else %}
    <h1>Error</h1>
    <p>
      No service data
    </p>
  {% endif %}
{% endblock %}
