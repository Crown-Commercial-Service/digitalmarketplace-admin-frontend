{% import 'macros/answers.html' as answers %}

{% extends "_base_page.html" %}
{% block page_title %}
  {{ service['serviceName'] }} â€“ Digital Marketplace admin
{% endblock %}

{% block breadcrumb %}
  {%
      with items = [
          {
              "link": url_for('.index'),
              "label": "Admin home"
          }
      ]
  %}
    {% include "toolkit/breadcrumb.html" %}
  {% endwith %}
{% endblock %}

{% block main_content %}
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
    {% if category == 'error' %}
        <div class="banner-destructive-without-action">
    {% else %}
        <div class="banner-success-without-action">
    {% endif %}
      <p class="banner-message">
          {% if message['bad_status'] %}
          Not a valid status: '{{ message['bad_status'] }}'
          {% elif message['status_error'] %}
          Error trying to update status of service: {{ message['status_error'] }}
          {% elif message['status_updated'] %}
          Service status has been updated to: {{ message['status_updated']|title }}
          {% endif %}
      </p>
      {% endfor %}
  </div>
  {% endif %}
  {% endwith %}

  {%
    with
    smaller = true,
    heading = service['serviceName'],
    context = service['supplierName']
  %}
    {% include "toolkit/page-heading.html" %}
  {% endwith %}
  {%
    with
      url = "/g-cloud/services/{}".format(service.id),
      text = "View service"
  %}
    {% include "toolkit/secondary-action-link.html" %}
  {% endwith %}
    <div class="grid-row">
      <div class="column-two-thirds">
        <p>
          {{ unack_update_events|length }} unacknowledged {{ pluralize(unack_update_events|length, "edit", "edits") }}
          {%- if unack_update_events %}
            by
            {% if n_editing_users == 1 %}
              {{ unack_update_events.0.user }}
            {% else %}
              {{ n_editing_users }} users
            {% endif %}
            {% if unack_update_events[0].createdAt|dateformat == unack_update_events[-1].createdAt|dateformat %}
              on {{ unack_update_events[0].createdAt|dateformat }}
            {%- else %}
              between {{ unack_update_events[0].createdAt|dateformat }}
              and {{ unack_update_events[-1].createdAt|dateformat }}
            {%- endif -%}
          {%- endif -%}
          .
        </p>
      </div>
    </div>

    {% if unack_update_events %}
    <div class="grid-row">
      <div class="column-one-half">
        <h3>
          Previously acknowledged version
        </h3>
        <p>
          Changed on {{ unack_update_events.0.createdAt|datetimeformat }}
        </p>
      </div>
      <div class="column-one-half">
        <h3>
          Current version
        </h3>
      </div>
    </div>
    <div class="diff">
    {% for diff_table in diffs.values() %}
      {{ diff_table }}
    {% else %}
      <p>All changes were reverted.</p>
    {% endfor %}
    </div><!-- end of .diff -->
    <form method="post" action="ACK_URL">
      <div style="display:none;">
        <input name="csrf_token" type="hidden" value="{{ csrf_token() }}"/>
      </div>
      <button type="submit" class="button-save">
        Acknowledge {{ pluralize(unack_update_events|length, "edit", "edits") }}
      </button>
    </form>
    {% endif %}

    <div class="grid-row">
      <div class="column-one-whole">
        <h4>Contact supplier:</h4>
        <p><a href="mailto:{{ supplier["contactInformation"][0]["email"] }}">
            {{ supplier["contactInformation"][0]["email"] }}
        </a></p>
      </div>
    </div>

    {% if current_user.has_role('admin') %}
    <form action="{{ url_for('.update_service_status', service_id=service.id ) }}" method="post">
        <div style="display:none;"><input id="csrf_token" name="csrf_token" type="hidden" value="{{ csrf_token() }}"></div>
        <fieldset class="question">
            <legend class="question-heading">
                Service status
            </legend>
            <label class="selection-button">
                <input type="radio" name="service_status" id="service_status_disabled" value="removed" {% if service['status'] == 'disabled' %}checked="checked"{% endif %} />
                Removed
            </label>
            <label class="selection-button">
                <input type="radio" name="service_status" id="service_status_private" value="private" {% if service['status'] == 'enabled' %}checked="checked"{% endif %} />
                Private
            </label>
            {% if service.status != 'disabled' %}
            <label class="selection-button">
                <input type="radio" name="service_status" id="service_status_published" value="public" {% if service['status'] == 'published' %}checked="checked"{% endif %} />
                Public
            </label>
            {% endif %}
        </fieldset>
        <button type="submit" class="button-save">Update status</button>
    </form>
    {% endif %}
  </div>
{% endblock %}
