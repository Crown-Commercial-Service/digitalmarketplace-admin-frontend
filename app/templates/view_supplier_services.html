{% import "toolkit/summary-table.html" as summary %}
{% import 'macros/answers.html' as answers %}

{% extends "_base_page.html" %}
{% block page_title %}
  {{ supplier.name }} â€“ Digital Marketplace admin
{% endblock %}

{% block breadcrumb %}
  {%
    with items = [
      {
        "link": url_for('.index'),
        "label": "Admin home"
      },
      {
        "label": supplier.name
      }
    ]
  %}
    {% include "toolkit/breadcrumb.html" %}
  {% endwith %}
{% endblock %}
{% block main_content %}

  {% block before_heading %}
    {% if remove_services_for_framework %}
      <div class="column-one-whole">
        <form action="{{ url_for('main.disable_supplier_services', supplier_id=supplier.id, remove=remove_services_for_framework.slug) }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          {%
            with
            message = "Are you sure you want to remove {}'s '{}' services?".format(supplier.name, remove_services_for_framework.name ),
            type = "destructive",
            action = '<button type="submit" class="button-destructive banner-action">Remove all services</button>'|safe
          %}
            {% include "toolkit/notification-banner.html" %}
          {% endwith %}
        </form>
      </div>
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for category, message in messages %}
        {% with message = message, type = "destructive" if category == 'error' else 'success' %}
          {% include "toolkit/notification-banner.html" %}
        {% endwith %}
      {% endfor %}
    {% endwith %}
  {% endblock %}

  <div class="grid-row">
    <div class="column-one-whole">
      {% with heading = "Services" %}
        {% include "toolkit/page-heading.html" %}
      {% endwith %}
    </div>
  </div>

  {% if not frameworks_services %}
    {% call(item) summary.list_table(
      empty_message="This supplier has no services on the Digital Marketplace."
    )
    %}{% endcall %}
  {% else %}
    {% for framework in frameworks | sort(attribute='id', reverse=True) %}
      {% if framework['slug'] in frameworks_services %}

        {{ summary.heading(framework['name'], id="{}_services".format(framework['slug'])) }}
        {% if 'published' in frameworks_services[framework['slug']]|map(attribute='status')|list and current_user.has_role('admin-ccs-category') %}
          {{ summary.top_link("Remove services", url_for(".find_supplier_services", supplier_id=supplier.id, remove=framework.slug)) }}
        {% endif %}

        {% set field_headings = ['Name', 'ID', 'Lot', 'Status'] %}
        {% if current_user.has_role('admin-ccs-category') %}
          {% set field_headings = field_headings + [summary.hidden_field_heading("Action")] %}
        {% endif %}
        {% call(item) summary.list_table(
          frameworks_services[framework['slug']],
          caption="Services",
          empty_message="This supplier has no services on the {} framework.".format(framework['name']),
          field_headings=field_headings,
          field_headings_visible=True
        ) %}
          {% call summary.row() %}
            {% if item.serviceName %}
              {{ summary.service_link(item.serviceName, '/' + item.frameworkFramework + '/services/' + item.id|string) }}
            {% else %}
              {% call summary.field(first=True, wide=True) %}
                {{ item.lotName }}
              {% endcall %}
            {% endif %}
            {{ summary.text(item.id) }}
            {{ summary.text(item.lotName) }}
            {% call summary.field() %}
              <span class="service-status-{{ item.status }}">
                {% if item.status == "published" %}
                  Public
                {% elif item.status == "enabled" %}
                  Private
                {% elif item.status == "disabled" %}
                  Removed
                {% else %}
                  {{ item.status|title }}
                {% endif %}
              </span>
            {% endcall %}
            {% if current_user.has_role('admin-ccs-category') %}
              {{ summary.edit_link('Edit', url_for('.view', service_id=item.id)) }}
            {% endif %}
          {% endcall %}
        {% endcall %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endblock %}
